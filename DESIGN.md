# Databricks RAG Chatbot - è¨­è¨ˆè³‡æ–™

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ)
3. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ](#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
5. [ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ](#ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ)
6. [è¨­å®šç®¡ç†æˆ¦ç•¥](#è¨­å®šç®¡ç†æˆ¦ç•¥)
7. [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼)
8. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
9. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ)
10. [é‹ç”¨è¨­è¨ˆ](#é‹ç”¨è¨­è¨ˆ)

---

## ğŸ“Œ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ç›®çš„
Databricksãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šã§å‹•ä½œã™ã‚‹ã€Retrieval-Augmented Generation (RAG) ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰

### ä¸»è¦æ©Ÿèƒ½
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è‡ªå‹•å–ã‚Šè¾¼ã¿ãƒ»ãƒãƒ£ãƒ³ã‚¯åŒ–
- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
- LLMã«ã‚ˆã‚‹è‡ªç„¶è¨€èªå¿œç­”ç”Ÿæˆ
- Streamlitãƒ™ãƒ¼ã‚¹ã®å¯¾è©±å‹UI
- ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
- ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ãƒ†ã‚£ã‚¹ãƒˆ
- MLã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- ãƒ“ã‚¸ãƒã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUIçµŒç”±ï¼‰

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     User Interface Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           Streamlit Web Application                    â”‚ â”‚
â”‚  â”‚  - Chat Interface                                      â”‚ â”‚
â”‚  â”‚  - Session Management                                  â”‚ â”‚
â”‚  â”‚  - Environment Detection (Databricks/Local)           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Model Serving Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      Databricks Model Serving Endpoint                â”‚ â”‚
â”‚  â”‚  - Auto-scaling (Scale to Zero)                       â”‚ â”‚
â”‚  â”‚  - Authentication (Bearer Token)                      â”‚ â”‚
â”‚  â”‚  - Versioned Model Deployment                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      RAG Chain Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Retriever  â”‚â†’ â”‚    Prompt    â”‚â†’ â”‚   LLM Model      â”‚  â”‚
â”‚  â”‚   (Vector    â”‚  â”‚   Template   â”‚  â”‚   (DBRX)         â”‚  â”‚
â”‚  â”‚    Search)   â”‚  â”‚              â”‚  â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vector Search Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      Databricks Vector Search Index                   â”‚ â”‚
â”‚  â”‚  - Delta Sync (TRIGGERED/CONTINUOUS)                  â”‚ â”‚
â”‚  â”‚  - Embedding Model: text-embedding-ada-002           â”‚ â”‚
â”‚  â”‚  - Similarity Search (k=3)                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Raw Documents  â”‚  â”€â”€â”€â”€â”€â”€â†’ â”‚  Chunked Documents       â”‚  â”‚
â”‚  â”‚  (Delta Table)  â”‚          â”‚  (Delta Table + CDF)     â”‚  â”‚
â”‚  â”‚                 â”‚          â”‚  - Change Data Feed      â”‚  â”‚
â”‚  â”‚  - doc_id       â”‚          â”‚  - id (primary key)      â”‚  â”‚
â”‚  â”‚  - title        â”‚          â”‚  - url                   â”‚  â”‚
â”‚  â”‚  - content      â”‚          â”‚  - content               â”‚  â”‚
â”‚  â”‚  - source       â”‚          â”‚                          â”‚  â”‚
â”‚  â”‚  - category     â”‚          â”‚                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Storage Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Unity Catalog                            â”‚ â”‚
â”‚  â”‚  - Catalog: rag_demo_{env}                           â”‚ â”‚
â”‚  â”‚  - Schema: chatbot                                    â”‚ â”‚
â”‚  â”‚  - Governance & Access Control                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“é¸å®šç†ç”±

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | æŠ€è¡“ | é¸å®šç†ç”± |
|--------------|------|---------|
| **ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸** | Delta Lake | ACIDãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«ã€Change Data Feed |
| **ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢** | Databricks Vector Search | ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã€Delta Syncã«ã‚ˆã‚‹è‡ªå‹•åŒæœŸ |
| **åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«** | text-embedding-ada-002 | é«˜ç²¾åº¦ã€å¤šè¨€èªå¯¾å¿œ |
| **LLM** | DBRX Instruct | Databricksãƒã‚¤ãƒ†ã‚£ãƒ–ã€é«˜é€Ÿæ¨è«– |
| **ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** | LangChain | RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ¨™æº–åŒ–ã€æŸ”è»Ÿæ€§ |
| **ãƒ¢ãƒ‡ãƒ«ç®¡ç†** | MLflow | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã€Unity Catalogçµ±åˆ |
| **UI** | Streamlit | è¿…é€Ÿãªãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€Pythonãƒã‚¤ãƒ†ã‚£ãƒ– |

---

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
databricks-rag-chatbot/
â”‚
â”œâ”€â”€ 00-config.py                           # ä¸­å¤®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ ç’°å¢ƒå¤‰æ•°å®šç¾© (ENV: dev/staging/prod)
â”‚   â”œâ”€â”€ Unity Catalogè¨­å®š
â”‚   â”œâ”€â”€ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©
â”‚   â”œâ”€â”€ ãƒãƒ£ãƒ³ã‚¯è¨­å®š
â”‚   â””â”€â”€ å‘½åè¦å‰‡é–¢æ•°
â”‚
â”œâ”€â”€ 01-setup/                              # ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
â”‚   â””â”€â”€ 01-validate-environment.py         # ç’°å¢ƒæ¤œè¨¼ãƒ»åˆæœŸåŒ–
â”‚       â”œâ”€â”€ Catalog/Schemaä½œæˆ
â”‚       â”œâ”€â”€ Vector Search Endpointç¢ºèª
â”‚       â””â”€â”€ Secretsæ¤œè¨¼
â”‚
â”œâ”€â”€ 02-data-pipeline/                      # ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
â”‚   â”œâ”€â”€ 01-ingest-and-chunk.py            # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ãƒãƒ£ãƒ³ã‚¯åŒ–
â”‚   â”‚   â”œâ”€â”€ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ LangChain TextSplitter
â”‚   â”‚   â”œâ”€â”€ Pandas UDF (åˆ†æ•£å‡¦ç†)
â”‚   â”‚   â””â”€â”€ Delta Tableä¿å­˜ (CDFæœ‰åŠ¹åŒ–)
â”‚   â”‚
â”‚   â””â”€â”€ 02-create-vector-index.py         # Vector Indexä½œæˆ
â”‚       â”œâ”€â”€ Delta Sync Indexä½œæˆ
â”‚       â”œâ”€â”€ å†ªç­‰æ€§ä¿è¨¼ (æ—¢å­˜Indexæ¤œå‡º)
â”‚       â”œâ”€â”€ Indexæº–å‚™å¾…æ©Ÿãƒ­ã‚¸ãƒƒã‚¯
â”‚       â””â”€â”€ æ¤œç´¢ãƒ†ã‚¹ãƒˆ
â”‚
â”œâ”€â”€ 03-model/                              # ãƒ¢ãƒ‡ãƒ«é–‹ç™ºãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
â”‚   â”œâ”€â”€ 01-build-rag-chain.py             # RAGãƒã‚§ãƒ¼ãƒ³æ§‹ç¯‰
â”‚   â”‚   â”œâ”€â”€ RetrieveråˆæœŸåŒ–
â”‚   â”‚   â”œâ”€â”€ Prompt Templateå®šç¾©
â”‚   â”‚   â”œâ”€â”€ LLMãƒ¢ãƒ‡ãƒ«æ¥ç¶š
â”‚   â”‚   â””â”€â”€ RetrievalQA Chainæ§‹ç¯‰
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-test-and-register.py           # ãƒ†ã‚¹ãƒˆãƒ»MLflowç™»éŒ²
â”‚   â”‚   â”œâ”€â”€ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®Ÿè¡Œ
â”‚   â”‚   â”œâ”€â”€ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
â”‚   â”‚   â”œâ”€â”€ MLflow Signatureä½œæˆ
â”‚   â”‚   â””â”€â”€ Unity Catalogç™»éŒ²
â”‚   â”‚
â”‚   â””â”€â”€ 03-deploy.py                      # ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤
â”‚       â”œâ”€â”€ æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
â”‚       â”œâ”€â”€ Endpointè¨­å®š (Secretsçµ±åˆ)
â”‚       â”œâ”€â”€ å†ªç­‰æ€§ä¿è¨¼ (ä½œæˆ/æ›´æ–°)
â”‚       â””â”€â”€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
â”‚
â”œâ”€â”€ 04-app/                                # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â””â”€â”€ streamlit_app.py                  # Streamlit UI
â”‚       â”œâ”€â”€ ç’°å¢ƒæ¤œå‡º (Databricks/Local)
â”‚       â”œâ”€â”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†
â”‚       â”œâ”€â”€ ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
â”‚       â”œâ”€â”€ APIå‘¼ã³å‡ºã— (Bearerèªè¨¼)
â”‚       â”œâ”€â”€ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
â”‚       â””â”€â”€ ã‚µã‚¤ãƒ‰ãƒãƒ¼æ©Ÿèƒ½
â”‚
â””â”€â”€ DESIGN.md                              # æœ¬è¨­è¨ˆè³‡æ–™
```

---

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Ingestion  â”‚  01-ingest-and-chunk.py
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1. Sample Document Generation
         â”‚ 2. DataFrame Creation
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Raw Documents   â”‚  Delta Table: raw_documents
â”‚  Delta Table     â”‚  - URL, Text, Metadata
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 3. LangChain Text Splitting
         â”‚ 4. Pandas UDF (Distributed Processing)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chunked Docs     â”‚  Delta Table: chunked_documents
â”‚  Delta Table     â”‚  - id, url, content
â”‚  (CDF enabled)   â”‚  - Change Data Feed âœ“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 5. Delta Sync Trigger
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vector Index    â”‚  02-create-vector-index.py
â”‚  Embedding       â”‚  - Embedding Generation
â”‚  Generation      â”‚  - Index Building
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 6. Similarity Search Ready
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAG Chain       â”‚  01-build-rag-chain.py
â”‚  Construction    â”‚  - Retriever + LLM
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 7. Model Registration
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MLflow Model    â”‚  02-test-and-register.py
â”‚  Registry        â”‚  - Unity Catalog Integration
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 8. Model Deployment
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Serving         â”‚  03-deploy.py
â”‚  Endpoint        â”‚  - Auto-scaling
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 9. User Query
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Streamlit UI    â”‚  streamlit_app.py
â”‚  (User)          â”‚  - Interactive Chat
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ•ãƒ­ãƒ¼ï¼ˆã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚ï¼‰

```
User Query: "Databricksã¨ã¯ï¼Ÿ"
    â†“
[Streamlit App]
    â†“ POST /serving-endpoints/{endpoint}/invocations
    â†“ Headers: Authorization: Bearer {token}
    â†“ Body: {"dataframe_records": [{"query": "..."}]}
    â†“
[Model Serving Endpoint]
    â†“ Load Model Version
    â†“
[RAG Chain - Retriever]
    â†“ 1. Embed Query
    â†“ 2. Vector Search (k=3)
    â†“
[Vector Search Index]
    â†“ Return: Top-3 Similar Chunks
    â†“
[RAG Chain - Prompt Builder]
    â†“ Construct Prompt:
    â†“   æƒ…å ±: {chunk1, chunk2, chunk3}
    â†“   è³ªå•: {query}
    â†“
[RAG Chain - LLM (DBRX)]
    â†“ Generate Response
    â†“
[Model Serving Endpoint]
    â†“ {"predictions": ["å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ"]}
    â†“
[Streamlit App]
    â†“ Display Answer
    â†“
[User]
```

---

## ğŸ§© ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 1. è¨­å®šç®¡ç†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (`00-config.py`)

#### è²¬å‹™
- ç’°å¢ƒã”ã¨ã®è¨­å®šç®¡ç†ï¼ˆdev/staging/prodï¼‰
- å‘½åè¦å‰‡ã®çµ±ä¸€
- å…¨ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¸ã®è¨­å®šå…±æœ‰

#### è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³
- **ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³è¨­è¨ˆ**: å…¨ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‹ã‚‰ `%run` ã§èª­ã¿è¾¼ã¿
- **ç’°å¢ƒåˆ†é›¢**: `ENV` å¤‰æ•°ã«ã‚ˆã‚‹ç’°å¢ƒåˆ‡ã‚Šæ›¿ãˆ
- **å‘½åè¦å‰‡é–¢æ•°**: `get_table_name()`, `get_model_name()`

#### ä¸»è¦è¨­å®šé …ç›®

| ã‚«ãƒ†ã‚´ãƒª | è¨­å®šé …ç›® | èª¬æ˜ |
|---------|---------|------|
| **ç’°å¢ƒ** | `ENV` | dev/staging/prod |
| **Unity Catalog** | `CATALOG`, `SCHEMA` | ãƒ‡ãƒ¼ã‚¿ã‚¬ãƒãƒŠãƒ³ã‚¹ |
| **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ** | `VECTOR_SEARCH_ENDPOINT` | Vector Search |
| | `EMBEDDING_MODEL_ENDPOINT` | åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ« |
| | `LLM_ENDPOINT` | LLMæ¨è«– |
| **ãƒ†ãƒ¼ãƒ–ãƒ«** | `RAW_DOCS_TABLE` | ç”Ÿãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| | `CHUNKED_DOCS_TABLE` | ãƒãƒ£ãƒ³ã‚¯åŒ–ãƒ‡ãƒ¼ã‚¿ |
| | `VECTOR_INDEX_NAME` | Vector Index |
| **ãƒ¢ãƒ‡ãƒ«** | `MODEL_NAME` | MLflowç™»éŒ²å |
| | `SERVING_ENDPOINT_NAME` | Serving Endpointå |
| **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ** | `SECRET_SCOPE`, `SECRET_KEY` | èªè¨¼æƒ…å ± |
| **ãƒãƒ£ãƒ³ã‚¯** | `CHUNK_CONFIG` | max_size, overlap, min_size |

---

### 2. ç’°å¢ƒæ¤œè¨¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (`01-validate-environment.py`)

#### è²¬å‹™
- å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã®å­˜åœ¨ç¢ºèª
- æ¬ è½ãƒªã‚½ãƒ¼ã‚¹ã®è‡ªå‹•ä½œæˆï¼ˆå¯èƒ½ãªå ´åˆï¼‰
- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã®æä¾›

#### å†ªç­‰æ€§ä¿è¨¼
- `CREATE CATALOG IF NOT EXISTS`
- `CREATE SCHEMA IF NOT EXISTS`
- æ—¢å­˜Vector Endpointã®æ¤œå‡º

#### æ¤œè¨¼é …ç›®

```python
validation_results = {
    "catalog": True/False,      # Unity Catalog
    "schema": True/False,        # Schema
    "vector_endpoint": True/False,  # Vector Search Endpoint
    "secrets": True/False        # Databricks Secrets
}
```

---

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 3.1 ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ãƒãƒ£ãƒ³ã‚¯åŒ– (`01-ingest-and-chunk.py`)

##### å‡¦ç†ãƒ•ãƒ­ãƒ¼
1. **ãƒ‡ãƒ¼ã‚¿å–å¾—**: ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼ˆå®Ÿé‹ç”¨ã§ã¯API/ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼‰
2. **Deltaä¿å­˜**: `RAW_DOCS_TABLE` ã«ä¿å­˜
3. **ãƒãƒ£ãƒ³ã‚¯åŒ–**: LangChain RecursiveCharacterTextSplitter
4. **åˆ†æ•£å‡¦ç†**: Pandas UDF ã«ã‚ˆã‚‹ä¸¦åˆ—å‡¦ç†
5. **Deltaä¿å­˜ï¼ˆCDFæœ‰åŠ¹ï¼‰**: `CHUNKED_DOCS_TABLE` ã«ä¿å­˜

##### ãƒãƒ£ãƒ³ã‚¯åŒ–æˆ¦ç•¥

```python
text_splitter = RecursiveCharacterTextSplitter.from_huggingface_tokenizer(
    tokenizer,
    chunk_size=500,      # ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãƒ™ãƒ¼ã‚¹
    chunk_overlap=50     # ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—
)
```

**è¨­è¨ˆç†ç”±:**
- **ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹**: LLMã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ¶é™ã«å¯¾å¿œ
- **ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—**: æ–‡è„ˆã®é€£ç¶šæ€§ã‚’ä¿æŒ
- **æœ€å°ã‚µã‚¤ã‚ºãƒ•ã‚£ãƒ«ã‚¿**: æ„å‘³ã®ãªã„ãƒãƒ£ãƒ³ã‚¯ã‚’é™¤å¤–

##### Pandas UDFè¨­è¨ˆ

```python
@pandas_udf("array<string>")
def chunk_text(texts: pd.Series) -> pd.Series:
    # Sparkãƒ¯ãƒ¼ã‚«ãƒ¼ã§ä¸¦åˆ—å®Ÿè¡Œ
    return texts.apply(split_function)
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- å¤§è¦æ¨¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®åˆ†æ•£å‡¦ç†
- Sparkã®ä¸¦åˆ—æ€§ã‚’æ´»ç”¨

---

#### 3.2 Vector Indexä½œæˆ (`02-create-vector-index.py`)

##### å‡¦ç†ãƒ•ãƒ­ãƒ¼
1. **æ—¢å­˜Indexç¢ºèª**: `get_index()` ã§ãƒã‚§ãƒƒã‚¯
2. **ä½œæˆ/åŒæœŸåˆ¤å®š**:
   - å­˜åœ¨ã—ãªã„ â†’ `create_delta_sync_index()`
   - å­˜åœ¨ã™ã‚‹ â†’ `index.sync()`
3. **æº–å‚™å¾…æ©Ÿ**: ãƒãƒ¼ãƒªãƒ³ã‚°ã§INDEX_READYçŠ¶æ…‹ã‚’ç¢ºèª
4. **ãƒ†ã‚¹ãƒˆæ¤œç´¢**: å‹•ä½œç¢ºèª

##### Delta Syncè¨­è¨ˆ

```python
vsc.create_delta_sync_index(
    endpoint_name=VECTOR_SEARCH_ENDPOINT,
    index_name=VECTOR_INDEX_NAME,
    source_table_name=CHUNKED_DOCS_TABLE,
    pipeline_type="TRIGGERED",  # or "CONTINUOUS"
    primary_key="id",
    embedding_source_column="content",
    embedding_model_endpoint_name=EMBEDDING_MODEL_ENDPOINT
)
```

**ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¿ã‚¤ãƒ—:**
- **TRIGGERED**: æ‰‹å‹•åŒæœŸï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰
- **CONTINUOUS**: è‡ªå‹•åŒæœŸï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§é‡è¦–ï¼‰

##### å†ªç­‰æ€§ä¿è¨¼

```python
try:
    index = vsc.get_index(...)
    index.sync()  # æ—¢å­˜Index
except ResourceNotFound:
    vsc.create_delta_sync_index(...)  # æ–°è¦ä½œæˆ
```

---

### 4. ãƒ¢ãƒ‡ãƒ«é–‹ç™ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 4.1 RAGãƒã‚§ãƒ¼ãƒ³æ§‹ç¯‰ (`01-build-rag-chain.py`)

##### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```python
RAG Chain = Retriever + Prompt Template + LLM

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Retriever   â”‚  Vector Search (k=3)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ context
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Prompt     â”‚  "æƒ…å ±: {context}\nè³ªå•: {question}"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ formatted_prompt
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     LLM      â”‚  DBRX Instruct (max_tokens=500)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ answer
       â†“
```

##### Retrieverè¨­è¨ˆ

```python
def get_retriever():
    vectorstore = DatabricksVectorSearch(
        vs_index,
        text_column="content",
        embedding=DatabricksEmbeddings(endpoint=EMBEDDING_MODEL_ENDPOINT)
    )
    return vectorstore.as_retriever(search_kwargs={"k": 3})
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
- `k=3`: ä¸Šä½3ä»¶ã®é¡ä¼¼ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—
- `text_column="content"`: ãƒãƒ£ãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã®ã‚«ãƒ©ãƒ å

##### Prompt Templateè¨­è¨ˆ

```python
TEMPLATE = """ä»¥ä¸‹ã®æƒ…å ±ã‚’ä½¿ã£ã¦è³ªå•ã«æ—¥æœ¬èªã§ç°¡æ½”ã«ç­”ãˆã¦ãã ã•ã„ã€‚
ç­”ãˆãŒã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€Œã‚ã‹ã‚Šã¾ã›ã‚“ã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚

æƒ…å ±:
{context}

è³ªå•: {question}

å›ç­”:"""
```

**è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ:**
- **è¨€èªæŒ‡å®š**: æ—¥æœ¬èªå¿œç­”ã‚’æ˜ç¤º
- **ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢**: "ã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€Œã‚ã‹ã‚Šã¾ã›ã‚“ã€"
- **ç°¡æ½”æ€§**: å†—é•·ãªå¿œç­”ã‚’æŠ‘åˆ¶

---

#### 4.2 ãƒ†ã‚¹ãƒˆãƒ»MLflowç™»éŒ² (`02-test-and-register.py`)

##### ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

```python
test_cases = [
    {
        "query": "Databricksã¨ã¯ï¼Ÿ",
        "expected_keywords": ["Databricks", "ãƒ‡ãƒ¼ã‚¿", "ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ "]
    },
    ...
]
```

**æ¤œè¨¼æ–¹æ³•:**
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹æ¤œè¨¼
- PASS/FAILåˆ¤å®š
- æˆåŠŸç‡ãƒ¬ãƒãƒ¼ãƒˆ

##### MLflowç™»éŒ²ãƒ•ãƒ­ãƒ¼

```python
1. mlflow.set_registry_uri("databricks-uc")  # Unity Catalogçµ±åˆ
2. infer_signature(input, output)            # è‡ªå‹•å‹æ¨è«–
3. mlflow.langchain.log_model(
       rag_chain,
       registered_model_name=MODEL_NAME,
       pip_requirements=[...]
   )
4. Model Registryç™»éŒ²å®Œäº†
```

**Unity Catalogçµ±åˆã®ãƒ¡ãƒªãƒƒãƒˆ:**
- ç´°ã‹ã„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- ãƒªãƒãƒ¼ã‚¸è¿½è·¡
- ã‚¬ãƒãƒŠãƒ³ã‚¹æ©Ÿèƒ½

---

#### 4.3 ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤ (`03-deploy.py`)

##### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­è¨ˆ

```python
EndpointCoreConfigInput(
    served_models=[
        ServedModelInput(
            model_name=MODEL_NAME,
            model_version=latest_version,
            workload_size="Small",           # Small/Medium/Large
            scale_to_zero_enabled=True,      # ã‚³ã‚¹ãƒˆæœ€é©åŒ–
            environment_vars={
                "DATABRICKS_TOKEN": "{{secrets/...}}"
            }
        )
    ]
)
```

**ä¸»è¦è¨­å®š:**
- **workload_size**: æ¨è«–è² è·ã«å¿œã˜ã¦é¸æŠ
- **scale_to_zero**: ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã®è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
- **Secretsçµ±åˆ**: ç’°å¢ƒå¤‰æ•°ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ³¨å…¥

##### å†ªç­‰æ€§ä¿è¨¼

```python
existing = w.serving_endpoints.list()

if existing:
    w.serving_endpoints.update_config_and_wait(...)  # æ›´æ–°
else:
    w.serving_endpoints.create_and_wait(...)        # ä½œæˆ
```

##### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ

```python
for q in test_queries:
    response = w.serving_endpoints.query(
        SERVING_ENDPOINT_NAME,
        dataframe_records=[{"query": q}]
    )
    assert response.predictions[0]  # å¿œç­”ç¢ºèª
```

---

### 5. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (`streamlit_app.py`)

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Environment Detection       â”‚
â”‚  Databricks âœ“ / Local ğŸ’»        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Session State             â”‚
â”‚  messages: [                    â”‚
â”‚    {role: "user", content: ...},â”‚
â”‚    {role: "assistant", ...}     â”‚
â”‚  ]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Chat Interface            â”‚
â”‚  - User Input                   â”‚
â”‚  - Message Display              â”‚
â”‚  - Spinner (Loading)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       API Client                â”‚
â”‚  - POST to Serving Endpoint     â”‚
â”‚  - Bearer Authentication        â”‚
â”‚  - Error Handling               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Sidebar                   â”‚
â”‚  - System Info                  â”‚
â”‚  - Sample Questions             â”‚
â”‚  - Chat Statistics              â”‚
â”‚  - Clear History                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç’°å¢ƒæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯

```python
try:
    from dbruntime.databricks_repl_context import get_context
    ctx = get_context()
    TOKEN = ctx.apiToken  # Databricksç’°å¢ƒ
    IN_DATABRICKS = True
except:
    TOKEN = os.getenv("DATABRICKS_TOKEN")  # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
    IN_DATABRICKS = False
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- åŒä¸€ã‚³ãƒ¼ãƒ‰ã§Databricks/ãƒ­ãƒ¼ã‚«ãƒ«ä¸¡å¯¾å¿œ
- ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹æŸ”è»Ÿãªè¨­å®š

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†

```python
if "messages" not in st.session_state:
    st.session_state.messages = []
```

**Streamlitã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹:**
- ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã‚‚æ°¸ç¶šåŒ–
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«åˆ†é›¢
- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ä¿æŒ

#### APIå‘¼ã³å‡ºã—è¨­è¨ˆ

```python
response = requests.post(
    ENDPOINT_URL,
    headers={
        "Authorization": f"Bearer {TOKEN}",
        "Content-Type": "application/json"
    },
    json={
        "dataframe_records": [{"query": prompt}]
    },
    timeout=60
)
```

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:**
- `RequestException`: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
- `Exception`: ä¸€èˆ¬ã‚¨ãƒ©ãƒ¼
- ã‚¨ãƒ©ãƒ¼è©³ç´°è¡¨ç¤ºï¼ˆ`e.response.text`ï¼‰

---

## âš™ï¸ è¨­å®šç®¡ç†æˆ¦ç•¥

### ç’°å¢ƒåˆ†é›¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

```python
ENV = "dev"  # "dev" | "staging" | "prod"

# ç’°å¢ƒã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒªã‚½ãƒ¼ã‚¹
CATALOG = f"rag_demo_{ENV}"
VECTOR_SEARCH_ENDPOINT = f"vs_endpoint_{ENV}"
SERVING_ENDPOINT_NAME = f"rag_endpoint_{ENV}"
SECRET_SCOPE = f"rag_demo_{ENV}"
```

### ç’°å¢ƒåˆ‡ã‚Šæ›¿ãˆæ‰‹é †

1. `00-config.py` ã® `ENV` å¤‰æ•°ã‚’å¤‰æ›´
2. å…¨ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å†å®Ÿè¡Œï¼ˆè¨­å®šãŒè‡ªå‹•åæ˜ ï¼‰

### è¨­å®šé …ç›®ã®éšå±¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Global Settings              â”‚
â”‚  - CATALOG, SCHEMA                  â”‚
â”‚  - CHUNK_CONFIG                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                     â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DEV   â”‚      â”‚   STAGING    â”‚  â”‚    PROD    â”‚
â”‚ Catalog â”‚      â”‚   Catalog    â”‚  â”‚  Catalog   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼

### ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

```bash
# Step 1: ç’°å¢ƒæ¤œè¨¼
01-setup/01-validate-environment.py
  â†’ Catalog/Schemaä½œæˆ
  â†’ Vector Endpointç¢ºèª
  â†’ Secretsç¢ºèª

# Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
02-data-pipeline/01-ingest-and-chunk.py
  â†’ ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ãƒãƒ£ãƒ³ã‚¯åŒ–
  â†’ Delta Tableä¿å­˜

02-data-pipeline/02-create-vector-index.py
  â†’ Vector Indexä½œæˆ
  â†’ åŒæœŸå¾…æ©Ÿ

# Step 3: ãƒ¢ãƒ‡ãƒ«é–‹ç™º
03-model/01-build-rag-chain.py
  â†’ RAGãƒã‚§ãƒ¼ãƒ³æ§‹ç¯‰
  â†’ å‹•ä½œç¢ºèª

03-model/02-test-and-register.py
  â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  â†’ MLflowç™»éŒ²

03-model/03-deploy.py
  â†’ Serving Endpointä½œæˆ
  â†’ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆ

# Step 4: UIèµ·å‹•
04-app/streamlit_app.py
  â†’ Streamlitèµ·å‹•
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹é–‹å§‹
```

### CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆï¼ˆæ¨å¥¨ï¼‰

```yaml
# .github/workflows/deploy.yml (ä¾‹)
name: Deploy RAG Chatbot

on:
  push:
    branches: [main]

jobs:
  deploy:
    steps:
      - name: Validate Environment
        run: databricks workspace import 01-setup/01-validate-environment.py

      - name: Run Data Pipeline
        run: |
          databricks jobs create --json-file jobs/data-pipeline.json
          databricks jobs run-now --job-id $JOB_ID

      - name: Deploy Model
        run: databricks workspace import 03-model/03-deploy.py

      - name: Integration Test
        run: pytest tests/
```

---

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ã‚³ã‚¢ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|---------|------|-----------|------|
| **ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ** | Databricks | - | çµ±åˆãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  |
| **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸** | Delta Lake | - | ACIDãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ« |
| **ã‚«ã‚¿ãƒ­ã‚°** | Unity Catalog | - | ãƒ‡ãƒ¼ã‚¿ã‚¬ãƒãƒŠãƒ³ã‚¹ |
| **ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢** | Databricks Vector Search | - | ãƒãƒãƒ¼ã‚¸ãƒ‰é¡ä¼¼æ¤œç´¢ |
| **ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** | LangChain | 0.1.x | RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ |
| **ãƒ¢ãƒ‡ãƒ«ç®¡ç†** | MLflow | 2.x | å®Ÿé¨“è¿½è·¡ã€ãƒ¢ãƒ‡ãƒ«ç™»éŒ² |
| **LLM** | DBRX Instruct | - | è‡ªç„¶è¨€èªç”Ÿæˆ |
| **åŸ‹ã‚è¾¼ã¿** | text-embedding-ada-002 | - | ãƒ™ã‚¯ãƒˆãƒ«åŒ– |
| **UI** | Streamlit | 1.x | Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ |
| **HTTP Client** | requests | 2.x | APIé€šä¿¡ |

### Pythonä¾å­˜é–¢ä¿‚

```
langchain
langchain-community
databricks-vectorsearch
mlflow
transformers
streamlit
requests
pandas
pyspark
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### èªè¨¼ãƒ»èªå¯

#### 1. Databricksèªè¨¼
```python
# Databricksç’°å¢ƒå†…
ctx = get_context()
TOKEN = ctx.apiToken  # è‡ªå‹•å–å¾—

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
TOKEN = os.getenv("DATABRICKS_TOKEN")  # ç’°å¢ƒå¤‰æ•°
```

#### 2. Secretsç®¡ç†
```python
# Databricks Secrets
dbutils.secrets.get(SECRET_SCOPE, SECRET_KEY)

# Model Servingç’°å¢ƒå¤‰æ•°ï¼ˆSecretså‚ç…§ï¼‰
environment_vars={
    "DATABRICKS_TOKEN": "{{secrets/rag_demo_dev/api_token}}"
}
```

#### 3. Unity Catalogã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
```sql
GRANT SELECT ON TABLE rag_demo_dev.chatbot.chunked_documents TO `data-scientists`;
GRANT EXECUTE ON MODEL rag_demo_dev.chatbot.rag_chatbot TO `ml-engineers`;
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

| é …ç›® | å®Ÿè£… |
|-----|------|
| **ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†** | Secrets Scopeä½¿ç”¨ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç¦æ­¢ |
| **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡** | Unity Catalogã§ç´°ç²’åº¦åˆ¶å¾¡ |
| **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** | HTTPSé€šä¿¡ã€VPC Endpointï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ |
| **ç›£æŸ»ãƒ­ã‚°** | Unity Catalogã®è‡ªå‹•ãƒ­ã‚°è¨˜éŒ² |
| **ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–** | Delta Lakeã®è‡ªå‹•æš—å·åŒ– |

---

## ğŸ“Š é‹ç”¨è¨­è¨ˆ

### ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æˆ¦ç•¥

#### 1. ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
```python
# MLflowãƒ¡ãƒˆãƒªã‚¯ã‚¹
mlflow.log_metrics({
    "latency_p50": 1.2,
    "latency_p99": 3.5,
    "throughput": 100
})
```

#### 2. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç›£è¦–
- Databricks Serving Endpoint Dashboard
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€ã‚¨ãƒ©ãƒ¼ç‡

#### 3. ãƒ‡ãƒ¼ã‚¿å“è³ª
```python
# Delta Tableãƒ¡ãƒˆãƒªã‚¯ã‚¹
df.count()  # ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°
df.schema   # ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
```

### ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

#### 1. Vector Search
- **Endpoint Type**: Standard / High Performance
- **Auto-scaling**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆé‡ã«å¿œã˜ã¦è‡ªå‹•

#### 2. Model Serving
```python
workload_size="Small"        # ä½è² è·
workload_size="Medium"       # ä¸­è² è·
workload_size="Large"        # é«˜è² è·
scale_to_zero_enabled=True   # ã‚³ã‚¹ãƒˆæœ€é©åŒ–
```

#### 3. ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
```python
pipeline_type="TRIGGERED"    # ãƒãƒƒãƒå‡¦ç†
pipeline_type="CONTINUOUS"   # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
```

### ã‚³ã‚¹ãƒˆæœ€é©åŒ–

| é …ç›® | æœ€é©åŒ–æ‰‹æ³• |
|-----|----------|
| **Compute** | Scale to Zeroæœ‰åŠ¹åŒ– |
| **Storage** | Delta Lakeã®ãƒ‡ãƒ¼ã‚¿åœ§ç¸®ã€OPTIMIZE |
| **Vector Search** | TRIGGEREDåŒæœŸï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰ |
| **ãƒ¢ãƒ‡ãƒ«** | é©åˆ‡ãªworkload_sizeé¸æŠ |

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚«ãƒãƒª

```python
# Delta Tableã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«
df = spark.read.format("delta").option("versionAsOf", 3).table(TABLE_NAME)

# MLflowãƒ¢ãƒ‡ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
client.transition_model_version_stage(
    name=MODEL_NAME,
    version="2",
    stage="Production"
)
```

---

## ğŸ“ˆ æ‹¡å¼µæ€§ãƒ»å°†æ¥è¨­è¨ˆ

### Phase 2æ‹¡å¼µè¨ˆç”»

1. **ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œ**
   - ç”»åƒãƒ»PDFç›´æ¥å‡¦ç†
   - OCRçµ±åˆ

2. **é«˜åº¦ãªRAG**
   - Hybrid Searchï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ + ãƒ™ã‚¯ãƒˆãƒ«ï¼‰
   - Re-ranking
   - Parent Document Retrieval

3. **è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**
   - è‡ªå‹•è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆRAGASï¼‰
   - A/Bãƒ†ã‚¹ãƒˆåŸºç›¤

4. **ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†
   - Conversation Memory
   - ãƒãƒ«ãƒã‚¿ãƒ¼ãƒ³å¯¾è©±

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é€²åŒ–

```
ç¾åœ¨: Batch RAG
  â””â”€ é™çš„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

Phase 2: Streaming RAG
  â””â”€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿

Phase 3: Agentic RAG
  â””â”€ ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã€è‡ªå¾‹çš„ãªã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
```

---

## ğŸ¯ æˆåŠŸæŒ‡æ¨™ï¼ˆKPIï¼‰

| ã‚«ãƒ†ã‚´ãƒª | æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|---------|------|-------|
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | P50ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | < 2ç§’ |
| | P99ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | < 5ç§’ |
| **å“è³ª** | å›ç­”ç²¾åº¦ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ï¼‰ | > 80% |
| | ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ | > 4.0/5.0 |
| **é‹ç”¨** | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¨¼åƒç‡ | > 99.5% |
| | ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç‡ | 100% |
| **ã‚³ã‚¹ãƒˆ** | æœˆé–“Computeè²»ç”¨ | äºˆç®—å†… |

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Databricks Vector Search Documentation](https://docs.databricks.com/en/generative-ai/vector-search.html)
- [LangChain Documentation](https://python.langchain.com/docs/get_started/introduction)
- [MLflow Documentation](https://mlflow.org/docs/latest/index.html)
- [Unity Catalog Best Practices](https://docs.databricks.com/en/data-governance/unity-catalog/index.html)

---

**Document Version:** 1.0
**Last Updated:** 2026-01-07
**Maintained By:** ML Engineering Team